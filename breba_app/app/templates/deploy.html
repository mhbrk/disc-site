<div class="d-flex flex-column h-100 p-3">
    <!-- Input + Button row -->
    <div class="mb-3">
        <label for="sitename" class="form-label">Website Name</label>
        <div class="input-group">
            <input type="text" id="sitename" class="form-control" placeholder="e.g. my-portfolio">
            <button id="deploy-button" class="btn btn-primary">Deploy</button>
        </div>
    </div>

    <!-- Status message -->
    <p id="deploy-status" class="form-text text-muted mt-2">
    </p>

    <!-- List of known deployments -->
    <div id="deploy-list" class="d-flex flex-column gap-2 mt-3"></div>
    <template id="deploy-card-template">
        <div class="card border rounded-3 shadow-sm px-3 py-2" data-id="">
            <a class="fw-medium text-decoration-none text-primary text-break url-link" target="_blank"
               rel="noopener noreferrer"></a>
        </div>
    </template>
</div>

<script>
    const sitenameInput = document.getElementById("sitename");
    const deployButton = document.getElementById("deploy-button");
    const statusText = document.getElementById("deploy-status");

    function autoLink(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, (url) => {
            return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
        });
    }

    function triggerDeploy() {
        const sitename = sitenameInput.value.trim();
        if (!sitename) {
            statusText.textContent = "Please enter a site name.";
            return;
        }

        statusText.textContent = "Deploying...";
        const chat = document.getElementById('chainlit');
        if (chat) {
            chat.contentWindow.postMessage({
                method: "deploy",
                body: sitename
            }, '*');
        }
    }

    deployButton.addEventListener("click", triggerDeploy);

    sitenameInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
            triggerDeploy();
        }
    });

    // Updates to builder panel
    window.addEventListener('message', (event) => {
        if (event.data.method === "deploy_status") {
            console.log('Deploy status message:', event.data);
            statusText.innerHTML = autoLink(event.data.body);
        } else if (event.data.method === "update_deployments_list") {
            const deployList = document.getElementById("deploy-list");
            const template = document.getElementById("deploy-card-template");

            deployList.innerHTML = "";

            const deployments = event.data.body || [];

            deployments.forEach(({id, url}) => {
                const clone = template.content.cloneNode(true);

                const card = clone.querySelector(".card");
                const urlLink = clone.querySelector(".url-link");
                urlLink.href = url;
                urlLink.textContent = url;

                card.dataset.id = id;

                deployList.appendChild(clone);
            });
        }
    });
</script>
