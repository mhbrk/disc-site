<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0 fw-semibold">Your Products</h5>
    <button type="button" id="create-btn" class="btn btn-primary d-flex align-items-center">
        <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
        <span>Create</span>
    </button>
</div>

<div id="products-list" class="row row-cols-1 g-3">
    {% for product in products %}
    <div class="col">
        <div class="card shadow-sm h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">{{ product.name }}</h6>
                <a href="#"
                   class="stretched-link"
                   data-product-id="{{ product.product_id }}">
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    const create_product_button = document.getElementById("create-btn");
    const spinner = create_product_button.querySelector(".spinner-border");
    const text = create_product_button.querySelector("span:last-child");

    create_product_button.addEventListener("click", () => {
        const chat = document.getElementById('chainlit');
        if (chat) {
            // Disable create_product_button
            create_product_button.disabled = true;

            // Show spinner
            spinner.classList.remove("d-none");

            // Send message
            chat.contentWindow.postMessage({
                method: "create_new_product",
                body: ""
            }, '*');
        }
    });
    window.addEventListener("message", (event) => {
        if (event.data.method === "update_products_list") {
            const products = event.data.body;
            const list = document.getElementById("products-list");
            list.innerHTML = "";

            products.forEach(product => {
                if (!product.name || !product.product_id) return;

                const col = document.createElement("div");
                col.className = "col";

                const card = document.createElement("div");
                card.className = "card shadow-sm h-100";

                const cardBody = document.createElement("div");
                cardBody.className = "card-body d-flex justify-content-between align-items-center";

                const title = document.createElement("h6");
                title.className = "card-title mb-0";
                title.textContent = product.name;

                const link = document.createElement("a");
                link.href = "#";
                link.className = "stretched-link";
                link.dataset.productId = product.product_id;

                cardBody.appendChild(title);
                cardBody.appendChild(link);
                card.appendChild(cardBody);
                col.appendChild(card);
                list.appendChild(col);
            });
        }
    });

    document.getElementById("products-list").addEventListener("click", (e) => {
        const link = e.target.closest("a.stretched-link");
        if (!link) return;
        const productId = link.dataset.productId;
        const chat = document.getElementById('chainlit');
        if (chat) {
            chat.contentWindow.postMessage({
                method: "product_selected",
                body: productId
            }, '*');
        }
    });
</script>